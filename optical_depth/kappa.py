import numpy as np
from scipy.interpolate import RegularGridInterpolator

# 1. Define the grid axes (log R and log T)
logR_axis = np.array([-8.0, -7.5, -7.0, -6.5, -6.0, -5.5, -5.0, -4.5, -4.0, -3.5, -3.0, -2.5, -2.0, -1.5, -1.0, -0.5, 0.0, 0.5, 1.0])
logT_axis = np.array([
    3.75, 3.80, 3.85, 3.90, 3.95, 4.00, 4.05, 4.10, 4.15, 4.20, 
    4.25, 4.30, 4.35, 4.40, 4.45, 4.50, 4.55, 4.60, 4.65, 4.70, 
    4.75, 4.80, 4.85, 4.90, 4.95, 5.00, 5.05, 5.10, 5.15, 5.20, 
    5.25, 5.30, 5.35, 5.40, 5.45, 5.50, 5.55, 5.60, 5.65, 5.70, 
    5.75, 5.80, 5.85, 5.90, 5.95, 6.00, 6.10, 6.20, 6.30, 6.40, 
    6.50, 6.60, 6.70, 6.80, 6.90, 7.00, 7.10, 7.20, 7.30, 7.40, 
    7.50, 7.60, 7.70, 7.80, 7.90, 8.00, 8.10, 8.30, 8.50, 8.70
])

# 2. Raw data from Table #73
# Each row corresponds to a logT value. Missing values are filled with np.nan.
raw_data = [
    [-0.767, -0.928, -1.119, -1.327, -1.542, -1.754, -1.955, -2.126, -2.236, -2.251, -2.166, -2.007, -1.799, -1.573, -1.304, -0.991, -0.645, -0.261, 0.131],
    [-0.561, -0.598, -0.675, -0.794, -0.944, -1.109, -1.273, -1.408, -1.493, -1.500, -1.425, -1.293, -1.107, -0.916, -0.688, -0.442, -0.180, 0.121, 0.429],
    [-0.534, -0.530, -0.525, -0.525, -0.543, -0.588, -0.649, -0.706, -0.739, -0.725, -0.663, -0.552, -0.406, -0.247, -0.051, 0.161, 0.384, 0.628, 0.894],
    [-0.536, -0.526, -0.508, -0.472, -0.407, -0.314, -0.212, -0.120, -0.042, 0.027, 0.102, 0.194, 0.310, 0.431, 0.589, 0.765, 0.954, 1.158, 1.377],
    [-0.537, -0.529, -0.512, -0.475, -0.396, -0.256, -0.046, 0.205, 0.446, 0.640, 0.781, 0.894, 0.997, 1.098, 1.220, 1.359, 1.511, 1.684, 1.877],
    [-0.518, -0.521, -0.513, -0.483, -0.411, -0.267, -0.034, 0.287, 0.651, 0.994, 1.262, 1.450, 1.587, 1.699, 1.806, 1.913, 2.040, 2.184, 2.348],
    [-0.490, -0.489, -0.486, -0.469, -0.413, -0.283, -0.052, 0.280, 0.683, 1.111, 1.500, 1.809, 2.030, 2.184, 2.302, 2.410, 2.518, 2.639, 2.774],
    [-0.479, -0.474, -0.464, -0.444, -0.395, -0.286, -0.083, 0.226, 0.626, 1.075, 1.529, 1.945, 2.274, 2.515, 2.687, 2.819, 2.936, 3.050, 3.172],
    [-0.469, -0.458, -0.445, -0.424, -0.376, -0.273, -0.089, 0.186, 0.553, 0.990, 1.467, 1.941, 2.365, 2.707, 2.954, 3.132, 3.275, 3.400, 3.521],
    [-0.474, -0.459, -0.439, -0.412, -0.365, -0.270, -0.099, 0.162, 0.508, 0.922, 1.387, 1.882, 2.359, 2.787, 3.129, 3.378, 3.557, 3.708, 3.841],
    [-0.475, -0.462, -0.441, -0.409, -0.357, -0.261, -0.101, 0.140, 0.473, 0.879, 1.335, 1.817, 2.314, 2.797, 3.220, 3.549, 3.790, 3.982, 4.141],
    [-0.466, -0.455, -0.436, -0.406, -0.357, -0.266, -0.108, 0.126, 0.446, 0.850, 1.313, 1.798, 2.293, 2.797, 3.269, 3.671, 3.979, 4.221, 4.409],
    [-0.454, -0.443, -0.424, -0.392, -0.343, -0.259, -0.114, 0.115, 0.439, 0.851, 1.316, 1.808, 2.313, 2.816, 3.313, 3.767, 4.136, 4.431, 4.652],
    [-0.431, -0.423, -0.406, -0.372, -0.319, -0.236, -0.103, 0.112, 0.433, 0.848, 1.318, 1.824, 2.347, 2.864, 3.379, 3.859, 4.272, 4.611, 4.861],
    [-0.421, -0.406, -0.384, -0.346, -0.283, -0.190, -0.051, 0.163, 0.475, 0.888, 1.363, 1.872, 2.400, 2.929, 3.460, 3.959, 4.400, 4.760, 5.047],
    [-0.415, -0.402, -0.380, -0.336, -0.259, -0.145, 0.009, 0.222, 0.526, 0.930, 1.405, 1.921, 2.456, 3.003, 3.545, 4.058, 4.519, 4.899, 5.201],
    [-0.410, -0.395, -0.373, -0.333, -0.254, -0.121, 0.068, 0.315, 0.633, 1.028, 1.491, 2.001, 2.530, 3.077, 3.625, 4.147, 4.615, 5.005, 5.312],
    [-0.413, -0.398, -0.373, -0.332, -0.256, -0.120, 0.091, 0.384, 0.738, 1.142, 1.595, 2.086, 2.601, 3.139, 3.686, 4.209, 4.676, 5.064, 5.365],
    [-0.410, -0.396, -0.376, -0.338, -0.263, -0.128, 0.087, 0.397, 0.794, 1.236, 1.697, 2.177, 2.673, 3.190, 3.719, 4.228, 4.684, 5.063, 5.352],
    [-0.408, -0.393, -0.372, -0.338, -0.273, -0.147, 0.064, 0.372, 0.768, 1.231, 1.723, 2.218, 2.709, 3.208, 3.713, 4.200, 4.638, 5.007, 5.288],
    [-0.409, -0.391, -0.368, -0.338, -0.278, -0.166, 0.030, 0.327, 0.715, 1.171, 1.668, 2.183, 2.690, 3.186, 3.673, 4.137, 4.560, 4.920, 5.199],
    [-0.408, -0.391, -0.369, -0.337, -0.280, -0.174, 0.009, 0.290, 0.660, 1.099, 1.583, 2.097, 2.621, 3.130, 3.612, 4.065, 4.476, 4.829, 5.103],
    [-0.409, -0.394, -0.371, -0.338, -0.283, -0.184, -0.009, 0.258, 0.610, 1.032, 1.506, 2.012, 2.537, 3.056, 3.547, 3.999, 4.406, 4.751, 5.017],
    [-0.400, -0.386, -0.366, -0.333, -0.277, -0.181, -0.017, 0.238, 0.579, 0.987, 1.449, 1.952, 2.475, 2.996, 3.494, 3.951, 4.356, 4.691, 4.942],
    [-0.380, -0.366, -0.346, -0.317, -0.265, -0.172, -0.013, 0.232, 0.566, 0.969, 1.423, 1.917, 2.435, 2.955, 3.456, 3.918, 4.321, 4.640, 4.871],
    [-0.339, -0.331, -0.315, -0.288, -0.239, -0.153, -0.003, 0.234, 0.565, 0.967, 1.416, 1.904, 2.418, 2.933, 3.436, 3.897, 4.291, 4.588, 4.795],
    [-0.269, -0.258, -0.245, -0.223, -0.181, -0.101, 0.041, 0.268, 0.591, 0.987, 1.430, 1.917, 2.423, 2.924, 3.420, 3.871, 4.246, 4.517, 4.702],
    [-0.198, -0.180, -0.160, -0.132, -0.091, -0.019, 0.110, 0.314, 0.608, 0.991, 1.438, 1.919, 2.417, 2.920, 3.398, 3.825, 4.172, 4.418, 4.588],
    [-0.157, -0.120, -0.083, -0.040, 0.015, 0.097, 0.221, 0.408, 0.680, 1.040, 1.468, 1.937, 2.421, 2.907, 3.355, 3.745, 4.061, 4.290, 4.455],
    [-0.163, -0.113, -0.058, 0.006, 0.085, 0.188, 0.330, 0.522, 0.776, 1.107, 1.511, 1.962, 2.424, 2.880, 3.288, 3.634, 3.921, 4.142, 4.312],
    [-0.215, -0.157, -0.089, -0.008, 0.091, 0.219, 0.384, 0.591, 0.841, 1.150, 1.532, 1.963, 2.406, 2.830, 3.196, 3.503, 3.768, 3.988, 4.166],
    [-0.281, -0.220, -0.147, -0.060, 0.051, 0.196, 0.381, 0.608, 0.873, 1.181, 1.540, 1.946, 2.365, 2.758, 3.089, 3.365, 3.614, 3.834, 4.022],
    [-0.357, -0.305, -0.236, -0.147, -0.035, 0.113, 0.309  , 0.555, 0.842, 1.163, 1.519, 1.905, 2.302, 2.671, 2.973, 3.229, 3.465, 3.688, 3.884],
    [-0.410, -0.372, -0.317, -0.240, -0.137, 0.003, 0.197  , 0.456, 0.767, 1.110, 1.471, 1.847, 2.229, 2.576, 2.858, 3.097, 3.327, 3.551, 3.751],
    [-0.444, -0.421, -0.381, -0.319, -0.226, -0.093, 0.094 , 0.354, 0.680, 1.043, 1.415, 1.788, 2.154, 2.482, 2.747, 2.974, 3.199, 3.423, 3.625],
    [-0.457, -0.446, -0.423, -0.380, -0.306, -0.189, -0.014, 0.238, 0.571, 0.955, 1.349, 1.728, 2.083, 2.393, 2.643, 2.862, 3.084, 3.306, 3.511],
    [-0.463, -0.457, -0.446, -0.420, -0.368, -0.272, -0.112, 0.136, 0.479, 0.881, 1.290, 1.668, 2.014, 2.310, 2.548, 2.760, 2.980, 3.199, 3.406],
    [-0.465, -0.462, -0.455, -0.440, -0.407, -0.338, -0.199, 0.039, 0.387, 0.807, 1.230, 1.614, 1.952, 2.235, 2.463, 2.670, 2.887, 3.103, 3.314],
    [-0.466, -0.463, -0.458, -0.448, -0.428, -0.383, -0.280, -0.070, 0.272, 0.710, 1.159, 1.557, 1.894, 2.167, 2.388, 2.592, 2.805, 3.017, 3.234],
    [-0.467, -0.464, -0.459, -0.451, -0.436, -0.403, -0.327, -0.158, 0.160, 0.604, 1.079, 1.498, 1.837, 2.108, 2.325, 2.528, 2.735, 2.946, 3.171],
    [-0.467, -0.465, -0.460, -0.453, -0.440, -0.413, -0.355, -0.223, 0.053, 0.490, 0.986, 1.429, 1.780, 2.052, 2.269, 2.470, 2.672, 2.877, 3.104],
    [-0.467, -0.465, -0.461, -0.454, -0.441, -0.417, -0.367, -0.258, -0.027, 0.378, 0.882, 1.348, 1.715, 1.994, 2.216, 2.418, 2.616, 2.817, 3.043],
    [-0.467, -0.465, -0.462, -0.455, -0.443, -0.419, -0.374, -0.278, -0.074, 0.293, 0.783, 1.263, 1.647, 1.935, 2.165, 2.370, 2.566, 2.770, 2.999],
    [-0.467, -0.465, -0.462, -0.457, -0.445, -0.423, -0.379, -0.290, -0.108, 0.223, 0.691, 1.178, 1.577, 1.877, 2.116, 2.325, 2.522, 2.723, 2.950],
    [-0.466, -0.464, -0.460, -0.455, -0.444, -0.423, -0.382, -0.298, -0.128, 0.180, 0.623, 1.103, 1.512, 1.825, 2.073, 2.287, 2.481, 2.672, 2.892],
    [-0.464, -0.461, -0.457, -0.451, -0.441, -0.422, -0.383, -0.302, -0.137, 0.159, 0.585, 1.054, 1.464, 1.784, 2.039, 2.255, 2.441, 2.622, 2.844],
    [-0.466, -0.460, -0.452, -0.442, -0.429, -0.409, -0.374, -0.303, -0.152, 0.118, 0.507, 0.956, 1.373, 1.712, 1.980, 2.187, 2.353, 2.528, 2.742],
    [-0.471, -0.468, -0.462, -0.450, -0.429, -0.397, -0.352, -0.280, -0.146, 0.092, 0.449, 0.882, 1.301, 1.643, 1.898, 2.080, 2.217, 2.389, 2.619],
    [-0.472, -0.471, -0.469, -0.465, -0.453, -0.424, -0.365, -0.268, -0.120, 0.104, 0.432, 0.838, 1.230, 1.544, 1.765, 1.915, 2.054, 2.240, 2.489],
    [-0.473, -0.472, -0.471, -0.470, -0.465, -0.451, -0.415, -0.323, -0.146, 0.109, 0.431, 0.796, 1.127, 1.383, 1.573, 1.718, 1.874, 2.089, 2.353],
    [-0.474, -0.473, -0.473, -0.472, -0.469, -0.462, -0.441, -0.382, -0.236, 0.029, 0.367, 0.695, 0.968, 1.179, 1.354, 1.513, 1.701, 1.941, 2.208],
    [-0.474, -0.474, -0.474, -0.473, -0.471, -0.467, -0.453, -0.414, -0.312, -0.099, 0.213, 0.522, 0.768, 0.962, 1.135, 1.316, 1.536, 1.799, 2.074],
    [-0.476, -0.475, -0.475, -0.475, -0.474, -0.470, -0.461, -0.433, -0.362, -0.205, 0.048, 0.325, 0.558, 0.750, 0.931, 1.133, 1.382, 1.660, 1.938],
    [-0.477, -0.477, -0.477, -0.476, -0.476, -0.473, -0.467, -0.448, -0.398, -0.283, -0.090, 0.141, 0.357, 0.552, 0.747, 0.974, 1.247, 1.535, 1.792],
    [-0.478, -0.478, -0.478, -0.478, -0.477, -0.475, -0.470, -0.457, -0.421, -0.340, -0.195, -0.004, 0.193, 0.387, 0.601, 0.845, 1.127, 1.410, 1.647],
    [-0.480, -0.480, -0.480, -0.480, -0.479, -0.476, -0.471, -0.460, -0.433, -0.373, -0.266, -0.115, 0.066, 0.270, 0.493, 0.742, 1.020, 1.285, 1.513],
    [-0.483, -0.483, -0.483, -0.482, -0.482, -0.480, -0.474, -0.460, -0.433, -0.382, -0.297, -0.171, -0.003, 0.190, 0.400, 0.638, 0.909, 1.161, 1.336],
    [-0.486, -0.486, -0.486, -0.486, -0.485, -0.484, -0.480, -0.467, -0.438, -0.386, -0.308, -0.195, -0.050, 0.116, 0.302, 0.533, 0.787, 1.027, np.nan],
    [-0.490, -0.490, -0.490, -0.490, -0.490, -0.489, -0.486, -0.477, -0.454, -0.406, -0.329, -0.224, -0.105, 0.030, 0.199, 0.420, 0.681, np.nan, np.nan],
    [-0.495, -0.495, -0.495, -0.495, -0.495, -0.494, -0.492, -0.487, -0.471, -0.434, -0.367, -0.276, -0.177, -0.061, 0.102, 0.319, 0.567, np.nan, np.nan],
    [-0.501, -0.501, -0.501, -0.501, -0.501, -0.501, -0.499, -0.495, -0.485, -0.460, -0.409, -0.336, -0.251, -0.144, 0.010, 0.226, np.nan, np.nan, np.nan],
    [-0.508, -0.508, -0.508, -0.508, -0.509, -0.509, -0.508, -0.505, -0.498, -0.481, -0.444, -0.387, -0.315, -0.217, -0.073, 0.127, np.nan, np.nan, np.nan],
    [-0.518, -0.518, -0.518, -0.518, -0.518, -0.518, -0.517, -0.516, -0.511, -0.498, -0.471, -0.429, -0.370, -0.283, -0.153, 0.026, np.nan, np.nan, np.nan],
    [-0.530, -0.530, -0.530, -0.530, -0.530, -0.530, -0.529, -0.529, -0.525, -0.515, -0.495, -0.463, -0.418, -0.346, -0.234, -0.088, np.nan, np.nan, np.nan],
    [-0.544, -0.544, -0.544, -0.544, -0.545, -0.545, -0.544, -0.544, -0.541, -0.533, -0.519, -0.497, -0.465, -0.411, -0.318, np.nan, np.nan, np.nan, np.nan],
    [-0.560, -0.560, -0.560, -0.560, -0.560, -0.561, -0.561, -0.560, -0.558, -0.552, -0.542, -0.530, -0.512, -0.475, -0.403, np.nan, np.nan, np.nan, np.nan],
    [-0.580, -0.580, -0.580, -0.580, -0.580, -0.580, -0.581, -0.581, -0.578, -0.574, -0.569, -0.566, -0.562, -0.544, -0.500, np.nan, np.nan, np.nan, np.nan],
    [-0.633, -0.633, -0.633, -0.633, -0.634, -0.634, -0.634, -0.633, -0.633, -0.633, -0.638, -0.654, -0.678, -0.698, -0.716, np.nan, np.nan, np.nan, np.nan],
    [-0.704, -0.704, -0.704, -0.704, -0.704, -0.704, -0.704, -0.704, -0.705, -0.710, -0.724, -0.759, -0.798, -0.915, -1.269, np.nan, np.nan, np.nan, np.nan],
    [-0.582, -0.753, -0.785, -0.789, -0.789, -0.789, -0.789, -0.789, -0.792, -0.801, -0.826, -0.882, -0.962, -1.051, np.nan, np.nan, np.nan, np.nan, np.nan]
]

# Convert to numpy array
opacity_grid = np.array(raw_data)

# 3. Create the Interpolator
# We use RegularGridInterpolator which is fast. Points with NaNs will return NaN.
# 'linear' provides the bilinear interpolation you requested.
interpolator = RegularGridInterpolator((logT_axis, logR_axis), opacity_grid, 
                                         method='linear', bounds_error=False, fill_value=None)

def kappa(R, T, is_log=True):
    """
    Interpolates OPAL Table #73.
    
    Parameters:
    -----------
    R : float
        The log10(R) or linear R value.
    T : float
        The log10(T) or linear T value.
    is_log : bool, optional
        If True, inputs are log10(R) and log10(T). Default is True.
        
    Returns:
    --------
    kappa : float
        The linear opacity (cm^2/g).
    """
    if not is_log:
        logR = np.log10(R)
        logT = np.log10(T)
    else:
        logR = R
        logT = T
        
    # Check bounds
    if logT < logT_axis[0] or logT > logT_axis[-1] or logR < logR_axis[0] or logR > logR_axis[-1]:
        print(f"Warning: (logT={logT}, logR={logR}) is outside table bounds.")
        return np.nan

    # Get log(kappa) from interpolator
    log_kappa = interpolator([logT, logR])[0]
    
    # Return linear opacity
    return 10**log_kappa
